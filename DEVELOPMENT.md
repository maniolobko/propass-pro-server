# PROPASS PRO - Development Guide

Complete guide for setting up a local development environment and contributing to the project.

## ğŸ› ï¸ Prerequisites

### Required
- Node.js 18+ ([nvm recommended](https://github.com/nvm-sh/nvm))
- PostgreSQL 14+ ([PostgreSQL.app for macOS](https://postgresapp.com/))
- Git
- VS Code (recommended editor)

### Recommended
- Docker Desktop (for containerized PostgreSQL)
- Postman or Insomnia (API testing)
- pgAdmin (database GUI)
- DBeaver (SQL IDE)

## ğŸš€ Local Setup

### 1. Clone Repository

```bash
git clone <repository-url>
cd propass-pro
cd propass-pro-server
```

### 2. Install Dependencies

```bash
npm install
```

Verify installation:
```bash
npm list
# Should show 40+ packages
```

### 3. Setup Database

#### Option A: Using Docker (Easier)

```bash
# Start PostgreSQL only (no server yet)
docker-compose up -d postgres pgadmin

# Verify it's running
docker-compose ps

# Access pgAdmin at http://localhost:5050
# Default login: admin@pgadmin.org / admin
```

#### Option B: Local PostgreSQL

```bash
# Start PostgreSQL service
brew services start postgresql  # macOS
# OR
sudo systemctl start postgresql  # Linux

# Create database and user
psql -U $(whoami) -c "CREATE DATABASE propass_db;"
psql -U $(whoami) -c "CREATE USER propass WITH PASSWORD 'propass123';"
psql -U $(whoami) -c "GRANT ALL PRIVILEGES ON DATABASE propass_db TO propass;"
```

### 4. Configure Environment

```bash
cp .env.example .env
```

Edit `.env`:

```bash
PORT=5000
DATABASE_URL="postgresql://propass:propass123@localhost:5432/propass_db"
JWT_SECRET="development-secret-key-min-32-characters-long!!!"
NODE_ENV="development"
LOG_LEVEL="debug"
```

### 5. Setup Database Schema

```bash
# Create tables and run migrations
npx prisma migrate dev

# Seed initial data (creates admin user)
npm run db:seed

# Verify tables created
npx prisma studio  # Opens GUI for database inspection
```

### 6. Start Development Server

```bash
npm run dev

# Should output:
# Server running on http://localhost:5000
# WebSocket server ready at ws://localhost:5000/ws
```

### 7. Verify Installation

```bash
# Health check
curl http://localhost:5000/health

# Expected response:
# {"status":"ok","timestamp":"2026-02-17T12:00:00Z"}

# Test login
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "device_id": "DEV_01"
  }'
```

## ğŸ“ Development Workflow

### Start Coding

```bash
# Terminal 1: Development server (auto-reload)
npm run dev

# Terminal 2: Database GUI (optional)
npx prisma studio

# Terminal 3: Test commands
curl ... # or use Postman
```

### Common Commands

```bash
# Run TypeScript compiler (check for errors)
npm run build

# Run tests
npm test

# Format code
npm run format

# Lint code
npm run lint

# View database schema
npx prisma schema

# Reset database (dangerous!)
npx prisma migrate reset

# Generate Prisma types (after schema changes)
npx prisma generate
```

## ğŸ”§ File Structure

```
src/
â”œâ”€â”€ server.ts              # Express app initialization
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth.ts            # JWT verification & role-based access
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.ts            # Login, refresh, me endpoints
â”‚   â”œâ”€â”€ clients.ts         # CRUD for clients
â”‚   â”œâ”€â”€ quotas.ts          # Quota management
â”‚   â”œâ”€â”€ copies.ts          # Badge copy history
â”‚   â”œâ”€â”€ dumps.ts           # Backup management
â”‚   â””â”€â”€ sync.ts            # Offline sync operations
â””â”€â”€ websocket/
    â””â”€â”€ handler.ts         # WebSocket connection management

prisma/
â””â”€â”€ schema.prisma          # Database schema definition

dist/                      # Compiled JavaScript (generated by: npm run build)
```

## ğŸ§ª Testing

### Manual Testing with cURL

```bash
# Get token
TOKEN=$(curl -s -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123","device_id":"DEV"}' \
  | jq -r '.token')

echo "Token: $TOKEN"

# Use token for requests
curl -X GET http://localhost:5000/api/clients \
  -H "Authorization: Bearer $TOKEN" \
  | jq
```

### Using Postman

1. Import API collection:
   ```bash
   # Create new Postman collection
   # Set base URL: http://localhost:5000
   # Add Auth header: Authorization: Bearer <token>
   ```

2. Create requests:
   - POST /api/auth/login
   - GET /api/clients
   - POST /api/copies
   - etc.

3. Create API tests:
   ```javascript
   // Tests tab in Postman
   pm.test("Status is 200", function() {
       pm.response.to.have.status(200);
   });
   
   pm.test("Response has token", function() {
       pm.expect(pm.response.json().token).to.exist;
   });
   ```

### Automated Testing

```bash
# Run Jest tests
npm test

# Run with coverage
npm test -- --coverage

# Watch mode (re-run on file changes)
npm test -- --watch
```

Example test file (`src/routes/auth.test.ts`):

```typescript
import request from 'supertest';
import app from '../server';

describe('Auth Routes', () => {
  test('POST /api/auth/login should return token', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        username: 'admin',
        password: 'admin123',
        device_id: 'TEST',
      });

    expect(response.status).toBe(200);
    expect(response.body.token).toBeDefined();
    expect(response.body.user.role).toBe('admin');
  });

  test('POST /api/auth/login should reject invalid password', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        username: 'admin',
        password: 'wrong',
        device_id: 'TEST',
      });

    expect(response.status).toBe(401);
    expect(response.body.success).toBe(false);
  });
});
```

## ğŸ› Debugging

### Enable Debug Logs

```bash
# Run with verbose logging
DEBUG=* npm run dev

# Or set in .env
LOG_LEVEL=debug

# Application logs output:
# [info] Server running on http://localhost:5000
# [debug] GET /api/clients from 127.0.0.1
# [debug] SQL: SELECT * FROM clients WHERE ...
```

### VS Code Debugger

Create `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Server",
      "program": "${workspaceFolder}/node_modules/ts-node-dev/lib/index.js",
      "args": ["--respawn", "src/server.ts"],
      "restart": true,
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    }
  ]
}
```

Then press F5 to start debugging.

Set breakpoints by clicking line numbers:
```typescript
// Line 45 - click to set breakpoint
const client = await prisma.clients.findUnique({
  where: { id: clientId },
});
```

### Database Inspection

```bash
# Open Prisma Studio (GUI)
npx prisma studio
# Opens http://localhost:5555

# Or use SQL directly
psql -U propass -d propass_db -c "SELECT * FROM users;"

# Check query performance
psql -U propass -d propass_db
\timing on
SELECT * FROM copies ORDER BY created_at DESC LIMIT 100;
```

## ğŸ“Š Database Migrations

### After Schema Changes

```typescript
// Update prisma/schema.prisma
model NewTable {
  id      Int     @id @default(autoincrement())
  name    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}
```

Then:

```bash
# Create new migration
npx prisma migrate dev --name add_new_table

# Name it: add_new_table

# Verify schema updated
npx prisma db push
```

### Rollback Migration

```bash
# Revert to previous migration
npx prisma migrate resolve --rolled-back "migration_name"

# Reset entire database
npx prisma migrate reset
# (WARNING: Deletes all data!)
```

## ğŸ” Security Checklist for Development

- [ ] Never commit `.env` file (use `.env.example`)
- [ ] Change JWT_SECRET in production
- [ ] Don't log passwords or tokens
- [ ] Use HTTPS in production (not localhost)
- [ ] Validate all user inputs
- [ ] Use parameterized queries (Prisma does this)
- [ ] Implement rate limiting before production
- [ ] Setup CORS properly for domains

## ğŸš¢ Before Committing

```bash
# 1. Check code quality
npm run lint
npm run format

# 2. Verify TypeScript
npm run build

# 3. Run tests
npm test

# 4. Verify database
npx prisma validate

# 5. Check for secrets
git diff --cached | grep -i "secret\|password\|token"
```

## ğŸ“š Code Style

### TypeScript Guidelines

```typescript
// âœ… Good: Explicit types
async function getClient(id: number): Promise<Client | null> {
  return await prisma.clients.findUnique({
    where: { id },
    include: { quotas: true },
  });
}

// âŒ Bad: Implicit any
async function getClient(id) {
  return prisma.clients.findUnique({ where: { id } });
}

// âœ… Good: Error handling
try {
  const result = await syncQueue();
  return { success: true, data: result };
} catch (error) {
  logger.error('Sync failed', { error });
  return { success: false, error: error.message };
}

// âŒ Bad: Silent failures
const result = await syncQueue().catch(e => null);
```

### Naming Conventions

```typescript
// Constants: UPPER_SNAKE_CASE
const MAX_RETRIES = 5;
const DEFAULT_TIMEOUT = 30000;

// Functions: camelCase
function recordCopy() {}
function validateToken() {}

// Classes: PascalCase
class SyncService {}
class WebSocketHandler {}

// Database fields: snake_case
prisma.users.create({
  data: {
    user_name: "...",  // NOT userName
    created_at: new Date(),
  }
});
```

## ğŸ”— Git Workflow

```bash
# Create feature branch
git checkout -b feature/add-email-notifications

# Make changes
git add .
git commit -m "feat: add email notifications on copy"

# Commit message format:
# feat: add feature
# fix: fix bug
# docs: update documentation
# test: add tests
# refactor: restructure code

# Push and create PR
git push origin feature/add-email-notifications
```

## ğŸ¤ Contributing

1. Fork repository
2. Create feature branch: `git checkout -b feature/name`
3. Make changes and test locally
4. Push to your fork
5. Create Pull Request with description

### PR Template

```
## Changes
- Added feature X
- Fixed bug Y

## Testing
- [ ] Tested locally
- [ ] Added unit tests
- [ ] Verified database migrations

## Breaking Changes
None / Describe...
```

## ğŸ“– Documentation

When adding features:

1. Update [API.md](API.md) with new endpoints
2. Add code comments for complex logic
3. Update [ARCHITECTURE.md](ARCHITECTURE.md) if changing flow
4. Update [README.md](README.md) if user-facing changes

## ğŸ› ï¸ Troubleshooting Setup

### Issue: "Database connection refused"

```bash
# Check if PostgreSQL is running
docker-compose ps
# OR
brew services list

# Start PostgreSQL if not running
docker-compose up -d postgres
# OR
brew services start postgresql

# Verify connection string in .env
DATABASE_URL="postgresql://propass:propass123@localhost:5432/propass_db"
```

### Issue: "Module not found: @prisma/client"

```bash
# Reinstall dependencies
rm -rf node_modules
npm install

# Regenerate Prisma client
npx prisma generate
```

### Issue: "Port 5000 already in use"

```bash
# Find process using port
lsof -i :5000

# Kill process
kill -9 <PID>

# OR use different port
PORT=5001 npm run dev
```

### Issue: "Migration conflict"

```bash
# Resolve migration conflict
npx prisma migrate status

# Reset migrations (DANGEROUS)
npx prisma migrate reset
```

## ğŸ“ Getting Help

- **Server issues**: Check logs with `npm run dev`
- **Database issues**: Use `npx prisma studio`
- **API issues**: Test with cURL or Postman
- **Type errors**: Run `npm run build` to check TypeScript
- **Performance**: Use `npm test -- --detectOpenHandles`

## ğŸš€ Next Steps

After successful setup:

1. Review [API.md](API.md) to understand endpoints
2. Check [ARCHITECTURE.md](ARCHITECTURE.md) to understand system design
3. Read [INTEGRATION.md](INTEGRATION.md) to understand client integration
4. Start coding! ğŸ‰

---

Happy developing! ğŸ’»
